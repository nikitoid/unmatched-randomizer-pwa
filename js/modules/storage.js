/**
 * –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
 * –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */

export class Storage {
    constructor() {
        this.storageKey = 'randomatched';
        this.init();
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    init() {
        this.migrateOldData();
        console.log('üíæ Storage module initialized');
    }

    /**
     * –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    migrateOldData() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π –∏ –º–∏–≥—Ä–∏—Ä—É–µ–º –∏—Ö
            const oldKeys = ['unmatched-randomizer', 'randomizer-data'];
            
            oldKeys.forEach(oldKey => {
                const oldData = localStorage.getItem(oldKey);
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        this.set('migrated_' + oldKey, parsed);
                        localStorage.removeItem(oldKey);
                        console.log(`Migrated data from ${oldKey}`);
                    } catch (error) {
                        console.warn(`Failed to migrate data from ${oldKey}:`, error);
                    }
                }
            });
        } catch (error) {
            console.warn('Migration failed:', error);
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    get(key, defaultValue = null) {
        try {
            const data = this.getAllData();
            return data.hasOwnProperty(key) ? data[key] : defaultValue;
        } catch (error) {
            console.warn(`Failed to get ${key} from storage:`, error);
            return defaultValue;
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
     */
    set(key, value) {
        try {
            const data = this.getAllData();
            data[key] = value;
            this.saveAllData(data);
            return true;
        } catch (error) {
            console.error(`Failed to set ${key} in storage:`, error);
            return false;
        }
    }

    /**
     * –£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    remove(key) {
        try {
            const data = this.getAllData();
            delete data[key];
            this.saveAllData(data);
            return true;
        } catch (error) {
            console.error(`Failed to remove ${key} from storage:`, error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    getAllData() {
        try {
            const data = localStorage.getItem(this.storageKey);
            return data ? JSON.parse(data) : {};
        } catch (error) {
            console.warn('Failed to parse storage data:', error);
            return {};
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
     */
    saveAllData(data) {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(data));
            return true;
        } catch (error) {
            console.error('Failed to save storage data:', error);
            return false;
        }
    }

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
     */
    clear() {
        try {
            localStorage.removeItem(this.storageKey);
            return true;
        } catch (error) {
            console.error('Failed to clear storage:', error);
            return false;
        }
    }

    /**
     * –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –∏—Å—Ç–æ—Ä–∏—é
     */
    addToHistory(team) {
        try {
            const history = this.get('history', []);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É –≤ –Ω–∞—á–∞–ª–æ
            history.unshift({
                ...team,
                savedAt: new Date().toISOString()
            });

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 50 –∑–∞–ø–∏—Å—è–º–∏
            if (history.length > 50) {
                history.splice(50);
            }

            this.set('history', history);
            return true;
        } catch (error) {
            console.error('Failed to add team to history:', error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–∞–Ω–¥
     */
    getHistory(limit = null) {
        try {
            const history = this.get('history', []);
            return limit ? history.slice(0, limit) : history;
        } catch (error) {
            console.error('Failed to get history:', error);
            return [];
        }
    }

    /**
     * –£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
     */
    removeFromHistory(teamId) {
        try {
            const history = this.get('history', []);
            const filteredHistory = history.filter(team => team.id !== teamId);
            this.set('history', filteredHistory);
            return true;
        } catch (error) {
            console.error('Failed to remove team from history:', error);
            return false;
        }
    }

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
     */
    clearHistory() {
        try {
            this.set('history', []);
            return true;
        } catch (error) {
            console.error('Failed to clear history:', error);
            return false;
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É
     */
    saveFavorite(team) {
        try {
            const favorites = this.get('favorites', []);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞
            const exists = favorites.some(fav => fav.id === team.id);
            if (!exists) {
                favorites.push({
                    ...team,
                    favoritedAt: new Date().toISOString()
                });
                this.set('favorites', favorites);
            }
            
            return true;
        } catch (error) {
            console.error('Failed to save favorite:', error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
     */
    getFavorites() {
        try {
            return this.get('favorites', []);
        } catch (error) {
            console.error('Failed to get favorites:', error);
            return [];
        }
    }

    /**
     * –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
     */
    removeFavorite(teamId) {
        try {
            const favorites = this.get('favorites', []);
            const filteredFavorites = favorites.filter(team => team.id !== teamId);
            this.set('favorites', filteredFavorites);
            return true;
        } catch (error) {
            console.error('Failed to remove favorite:', error);
            return false;
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     */
    saveSettings(settings) {
        try {
            const currentSettings = this.get('settings', {});
            const newSettings = { ...currentSettings, ...settings };
            this.set('settings', newSettings);
            return true;
        } catch (error) {
            console.error('Failed to save settings:', error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     */
    getSettings() {
        try {
            return this.get('settings', {
                heroCount: '2',
                gameMode: 'all',
                theme: 'system',
                notifications: true,
                autoSave: true
            });
        } catch (error) {
            console.error('Failed to get settings:', error);
            return {};
        }
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    exportData() {
        try {
            const data = this.getAllData();
            return {
                data: data,
                exportedAt: new Date().toISOString(),
                version: '1.0.0',
                app: 'Randomatched'
            };
        } catch (error) {
            console.error('Failed to export data:', error);
            return null;
        }
    }

    /**
     * –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
     */
    importData(importedData) {
        try {
            if (!importedData || !importedData.data) {
                throw new Error('Invalid import data');
            }

            // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            const backup = this.exportData();
            this.set('backup_' + Date.now(), backup);

            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            this.saveAllData(importedData.data);
            
            return true;
        } catch (error) {
            console.error('Failed to import data:', error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    getStorageStats() {
        try {
            const data = this.getAllData();
            const history = this.get('history', []);
            const favorites = this.get('favorites', []);
            
            return {
                totalKeys: Object.keys(data).length,
                historyCount: history.length,
                favoritesCount: favorites.length,
                storageSize: JSON.stringify(data).length,
                lastModified: this.get('lastModified', null)
            };
        } catch (error) {
            console.error('Failed to get storage stats:', error);
            return {};
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
     */
    isAvailable() {
        try {
            const testKey = '__test__';
            localStorage.setItem(testKey, 'test');
            localStorage.removeItem(testKey);
            return true;
        } catch (error) {
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    getStorageSize() {
        try {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return total;
        } catch (error) {
            return 0;
        }
    }

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
     */
    cleanup() {
        try {
            const history = this.get('history', []);
            const favorites = this.get('favorites', []);
            
            // –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const filteredHistory = history.filter(team => {
                const teamDate = new Date(team.savedAt || team.createdAt);
                return teamDate > thirtyDaysAgo;
            });
            
            if (filteredHistory.length !== history.length) {
                this.set('history', filteredHistory);
                console.log(`Cleaned up ${history.length - filteredHistory.length} old history entries`);
            }
            
            return true;
        } catch (error) {
            console.error('Failed to cleanup storage:', error);
            return false;
        }
    }
}
